# ACM Configuration Files Index

This directory contains all files needed to deploy and manage ACM multi-cluster platform deployments.

## File Organization

### üìã Core Configuration (Apply in Order)

1. **`01-managedclusterset.yaml`**

   - Creates the `homelab` ManagedClusterSet
   - Groups managed clusters for RBAC and targeting
   - Uses ExclusiveClusterSetLabel for explicit cluster assignment

2. **`02-managedclustersetbinding.yaml`**

   - Binds homelab ClusterSet to openshift-gitops namespace
   - Allows Argo CD to deploy to clusters in the set

3. **`03-placement-platform.yaml`**

   - Primary placement selecting all clusters in homelab set
   - Used by ApplicationSets to target managed clusters

4. **`03-placement-examples.yaml`** (Optional)
   - Additional placement examples for different scenarios
   - SNO-only, multinode, prod-only, test-only placements

### üöÄ ApplicationSets (Choose One)

## ApplicationSet Files

- **`homelab-platform-simple.yaml`** - ‚≠ê **WORKING** - Simple clusters generator approach
- **`homelab-platform-applicationset.yaml`** - Full platform chart (clusterDecisionResource - has RBAC issues)
- **`homelab-platform-applicationset-template.yaml`** - Editable template version
- **`homelab-platform-components-applicationset.yaml`** - Individual components (clusterDecisionResource - has RBAC issues)
- **`homelab-platform-components-applicationset-template.yaml`** - Editable template version

### üõ†Ô∏è Scripts

- **`deploy-acm-config.sh`** - Automated deployment of ClusterSet, Binding, and Placements
- **`04-label-clusters.sh`** - Labels managed clusters with appropriate tags
- **`cleanup-acm-config.sh`** - Removes all ACM configuration

### üìö Documentation

## Documentation Files

- **`README.md`** - Complete setup and usage guide
- **`INDEX.md`** - This file - file index and quick reference
- **`EXTRACTION-SUMMARY.md`** - Details of extracted configuration
- **`WORKING-CONFIG.md`** - ‚≠ê **NEW** - Technical details of working deployment
- **`DEPLOYMENT-STATUS.md`** - ‚≠ê **NEW** - Current deployment status and commands

## Quick Reference

### Initial Setup

```bash
# 1. Deploy ACM configuration
./acm/deploy-acm-config.sh

# 2. Label clusters
./acm/04-label-clusters.sh

# 3. Deploy ApplicationSet (choose one)
oc apply -f acm/homelab-platform-applicationset.yaml
```

### Verify Setup

```bash
# Check ClusterSet
oc get managedclusterset homelab

# Check Placement decisions
oc get placementdecision -n openshift-gitops

# Check ApplicationSets
oc get applicationset -n openshift-gitops

# Check Applications
oc get applications -n openshift-gitops | grep -E "prod-|test-"
```

### Cleanup

```bash
# Remove all ACM configuration
./acm/cleanup-acm-config.sh
```

## File Relationships

```
ManagedClusterSet (homelab)
    ‚Üì
ManagedClusterSetBinding (homelab ‚Üí openshift-gitops)
    ‚Üì
Placement (platform-placement-1)
    ‚Üì
PlacementDecision (generated by ACM)
    ‚Üì
ApplicationSet (homelab-platform or homelab-platform-components)
    ‚Üì
Applications (prod-*, test-*, etc.)
    ‚Üì
Platform Components (deployed to managed clusters)
```

## Customization Guide

### To Deploy Different Components Per Cluster

1. Create separate Placements (e.g., sno-placement, multinode-placement)
2. Create multiple ApplicationSets, each referencing a different placement
3. Customize component lists in each ApplicationSet

### To Use Cluster-Specific Values

1. Create values files per cluster: `values-prod-acm.yaml`, `values-test-acm.yaml`
2. Update ApplicationSet to reference values file:
   ```yaml
   helm:
     valueFiles:
       - values-{{name}}-acm.yaml
   ```

### To Conditionally Enable Components

1. Add labels to managed clusters (e.g., `gpu=nvidia`, `storage=truenas`)
2. Use matrix generator with conditionals:
   ```yaml
   - name: amd-gpu-operator
     enabled: "{{metadata.labels.gpu}}"
   ```

## Common Tasks

### Add a New Managed Cluster

```bash
# 1. Import cluster via ACM console or CLI
# 2. Label the cluster
oc label managedcluster newcluster cluster.open-cluster-management.io/clusterset=homelab
oc label managedcluster newcluster environment=homelab topology=sno

# 3. Verify placement picks it up
oc get placementdecision platform-placement-1-decision-1 -n openshift-gitops -o yaml

# ApplicationSet will automatically create Applications for the new cluster
```

### Remove a Cluster from Deployment

```bash
# Remove clusterset label
oc label managedcluster <name> cluster.open-cluster-management.io/clusterset-

# Or update placement to exclude it
# Edit placement to add label selector excluding the cluster
```

### Deploy to Single Cluster for Testing

```bash
# Create test-specific placement
cat <<EOF | oc apply -f -
apiVersion: cluster.open-cluster-management.io/v1beta1
kind: Placement
metadata:
  name: platform-placement-test-only
  namespace: openshift-gitops
spec:
  clusterSets: [homelab]
  predicates:
    - requiredClusterSelector:
        labelSelector:
          matchLabels:
            name: test
EOF

# Create test ApplicationSet referencing this placement
# Copy homelab-platform-applicationset-template.yaml and update placement reference
```

## Troubleshooting Reference

### ApplicationSet Not Creating Applications

```bash
# Check placement decisions
oc get placementdecision -n openshift-gitops -o yaml

# Check ApplicationSet status
oc get applicationset homelab-platform -n openshift-gitops -o yaml | grep -A 20 status

# Check ACM placement controller
oc get pods -n open-cluster-management-hub | grep placement
```

### Applications Failing to Sync

```bash
# Check application status
oc get application <cluster>-<component> -n openshift-gitops -o yaml

# Check if Argo CD can reach managed cluster
oc get secret -n openshift-gitops | grep <cluster>

# Verify managed cluster is healthy
oc get managedcluster <cluster> -o yaml | grep -A 10 conditions
```

### PlacementDecisions Empty

```bash
# Verify clusters are labeled
oc get managedclusters -l cluster.open-cluster-management.io/clusterset=homelab

# Check placement predicates
oc get placement platform-placement-1 -n openshift-gitops -o yaml

# Check if ClusterSetBinding exists
oc get managedclustersetbinding homelab -n openshift-gitops
```

## Best Practices

1. **Version Control**: Commit all YAML files to Git
2. **Test First**: Deploy to test cluster before prod
3. **Use Templates**: Start with template files and customize
4. **Label Consistently**: Use standard labels across clusters
5. **Monitor Closely**: Watch first deployment to catch issues
6. **Document Changes**: Update README when adding new configurations
7. **Backup Config**: Export and save placement/clusterset configs
8. **Gradual Rollout**: Deploy components incrementally, not all at once

## Next Steps

After setting up ACM configuration:

1. ‚úÖ Deploy platform components to managed clusters
2. ‚¨ú Create ApplicationSets for application workloads (ai, media, etc.)
3. ‚¨ú Set up ACM policies for governance
4. ‚¨ú Configure observability for multi-cluster monitoring
5. ‚¨ú Implement backup strategy for ACM configuration
